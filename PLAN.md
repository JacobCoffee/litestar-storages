# litestar-storages Implementation Plan

## Executive Summary

**litestar-storages** is an async-first file storage abstraction library for Litestar, providing a unified interface for storing and retrieving files across multiple cloud and local backends.

### Key Differentiators

- **Async-native**: Built from the ground up for async/await, unlike django-storages (sync) or fastapi-storages (sync despite the name)
- **Litestar Integration**: First-class plugin support with dependency injection, lifespan management, and DTO integration
- **Modern Python**: Type-safe with full typing support, dataclass-based configuration, protocol-driven design

---

## Implementation Status

### Completed

- [x] **Phase 1: Foundation (MVP)**
  - [x] Project scaffolding with pyproject.toml, CI/CD
  - [x] Core protocol and base class (`base.py`, `types.py`, `exceptions.py`)
  - [x] MemoryStorage backend (for testing)
  - [x] FileSystemStorage backend (with aiofiles)
  - [x] Basic test suite with protocol compliance tests
  - [x] Documentation (Sphinx with Shibuya theme)

- [x] **Phase 2: Cloud Storage (S3)**
  - [x] S3Storage backend with full feature set
  - [x] S3 test suite (30 tests using moto server mode)
  - [x] Documentation for S3 configuration
  - [ ] S3-compatible service validation (R2, Spaces, MinIO) - needs real-world testing

- [x] **Phase 3: Litestar Integration**
  - [x] StoragePlugin implementation
  - [x] Dependency injection support (`provide_storage`)
  - [x] Response DTOs (`StoredFileDTO`)
  - [x] Integration tests with real Litestar app (15 tests)
  - [ ] Lifespan management for connection cleanup

- [x] **Project Infrastructure**
  - [x] CI workflow (lint, format, type-check, test matrix)
  - [x] CD workflow (changelog generation, trusted PyPI publishing)
  - [x] git-cliff for automated changelogs
  - [x] Makefile with comprehensive targets
  - [x] prek hooks (pre-commit alternative)
  - [x] ty type checker (Rust-based)
  - [x] CONTRIBUTING.rst guide
  - [x] GitHub PR template

- [x] **Test Suite Optimization** (awesome-pytest-speedup checklist)
  - [x] Fast collection (~0.12s for 145 tests)
  - [x] PYTHONDONTWRITEBYTECODE=1 in Makefile and CI
  - [x] Disabled unused pytest plugins (pastebin, nose, doctest)
  - [x] pytest-socket for network access control
  - [x] pytest-timeout (60s) for hanging test protection
  - [x] pytest-xdist for parallel execution
  - [x] pytest-sugar for better output
  - [x] Optimized fixture scoping (session for immutable data)
  - [x] norecursedirs configured for faster collection

### In Progress

- [ ] **Phase 4: Additional Backends**
  - [ ] GCSStorage backend (Google Cloud Storage)
  - [ ] AzureStorage backend (Azure Blob Storage)
  - [ ] Backend-specific documentation
  - [ ] Migration guide between backends

### Not Started

- [ ] **Phase 5: Polish & Release**
  - [ ] API reference generation (autodoc)
  - [ ] Performance benchmarks
  - [ ] Security audit
  - [ ] PyPI release (v0.1.0)

---

## Current Project Structure

```
litestar-storages/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ litestar_storages/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py           # Public API exports
‚îÇ       ‚îú‚îÄ‚îÄ __metadata__.py       # Version from importlib.metadata
‚îÇ       ‚îú‚îÄ‚îÄ base.py               # Storage protocol + BaseStorage ABC
‚îÇ       ‚îú‚îÄ‚îÄ types.py              # StoredFile, UploadResult dataclasses
‚îÇ       ‚îú‚îÄ‚îÄ exceptions.py         # StorageError hierarchy (prefixed names)
‚îÇ       ‚îú‚îÄ‚îÄ backends/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py       # Backend exports
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ filesystem.py     # Local filesystem (aiofiles)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ memory.py         # In-memory (testing)
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ s3.py             # S3-compatible (aioboto3)
‚îÇ       ‚îî‚îÄ‚îÄ contrib/
‚îÇ           ‚îú‚îÄ‚îÄ __init__.py
‚îÇ           ‚îú‚îÄ‚îÄ plugin.py         # Litestar StoragePlugin
‚îÇ           ‚îú‚îÄ‚îÄ dependencies.py   # DI utilities
‚îÇ           ‚îî‚îÄ‚îÄ dto.py            # Response DTOs
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py               # Shared fixtures
‚îÇ   ‚îú‚îÄ‚îÄ test_protocol.py          # Protocol compliance (all backends)
‚îÇ   ‚îú‚îÄ‚îÄ backends/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_filesystem.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_memory.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_s3.py            # @pytest.mark.integration
‚îÇ   ‚îî‚îÄ‚îÄ contrib/
‚îÇ       ‚îú‚îÄ‚îÄ test_plugin.py        # @pytest.mark.integration
‚îÇ       ‚îî‚îÄ‚îÄ test_dto.py           # @pytest.mark.integration
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ conf.py                   # Sphinx config (Shibuya theme)
‚îÇ   ‚îú‚îÄ‚îÄ index.md                  # Landing page
‚îÇ   ‚îú‚îÄ‚îÄ getting-started.md
‚îÇ   ‚îú‚îÄ‚îÄ changelog.md              # Auto-generated by git-cliff
‚îÇ   ‚îú‚îÄ‚îÄ backends/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ filesystem.md
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ s3.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ memory.md
‚îÇ   ‚îî‚îÄ‚îÄ advanced/
‚îÇ       ‚îî‚îÄ‚îÄ custom-backends.md
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îú‚îÄ‚îÄ workflows/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ci.yml                # Lint, format, type-check, test matrix
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cd.yml                # Changelog + PyPI publish
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docs.yml              # GitHub Pages deploy
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ release.yml
‚îÇ   ‚îî‚îÄ‚îÄ PULL_REQUEST_TEMPLATE.md
‚îú‚îÄ‚îÄ .claude/
‚îÇ   ‚îî‚îÄ‚îÄ CLAUDE.md                 # Development instructions
‚îú‚îÄ‚îÄ pyproject.toml                # uv_build backend, dependency-groups
‚îú‚îÄ‚îÄ Makefile                      # Development targets
‚îú‚îÄ‚îÄ CONTRIBUTING.rst
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ LICENSE
‚îî‚îÄ‚îÄ PLAN.md                       # This file
```

---

## Dependency Configuration

### Core Dependencies
```toml
dependencies = ["litestar>=2.0.0"]
```

### Optional Backend Extras
```toml
[project.optional-dependencies]
filesystem = ["aiofiles>=23.0.0"]
s3 = ["aioboto3>=12.0.0"]
gcs = ["gcloud-aio-storage>=9.0.0"]      # Not yet implemented
azure = ["azure-storage-blob>=12.0.0"]   # Not yet implemented
all = [...]
```

### Development Groups
```toml
[dependency-groups]
dev = [...]   # All dev deps
docs = [...]  # Sphinx, shibuya, myst-parser
lint = [...]  # prek, ruff, codespell, ty
test = [...]  # pytest, pytest-asyncio, moto
```

---

## Exception Naming Convention

Exceptions are prefixed with `Storage` to avoid shadowing Python builtins:

| Our Exception | Avoids Shadowing |
|---------------|------------------|
| `StorageFileNotFoundError` | `FileNotFoundError` |
| `StorageFileExistsError` | `FileExistsError` |
| `StoragePermissionError` | `PermissionError` |
| `StorageConnectionError` | `ConnectionError` |
| `StorageError` | Base class |
| `ConfigurationError` | Configuration issues |

---

## Testing Status

| Test Category | Count | Status |
|---------------|-------|--------|
| Unit tests (memory, filesystem) | 97 | ‚úÖ Passing |
| Skipped (platform-specific) | 3 | ‚è≠Ô∏è Expected |
| Integration tests (S3, plugin) | 45 | üî∂ Deselected in CI |

**Test Performance:**
- Collection: ~0.12s (145 tests)
- Unit tests: ~0.33s (97 tests, sequential)
- Parallel ready when suite grows to 200+ tests

**Run tests:**
```bash
make test-fast        # Unit tests only (default)
make test             # All tests including integration
make test-cov         # With coverage report
make test-parallel    # All tests in parallel (pytest-xdist)
make test-debug       # Verbose with no capture
make test-failed      # Re-run only failed tests
```

---

## Next Steps (Priority Order)

### Immediate (v0.1.0 Release)

1. **Fix remaining integration tests**
   - S3 tests with moto have Python 3.14 compatibility issues
   - Plugin tests need Litestar test client setup

2. **Add lifespan management to StoragePlugin**
   - Cleanup S3 clients on app shutdown
   - Context manager support for storages

3. **First PyPI release**
   - Tag v0.1.0
   - Verify trusted publishing works

### Short-term (v0.2.0)

4. **GCS Backend**
   - Implement GCSStorage with gcloud-aio-storage
   - Add GCS-specific tests
   - Document authentication options

5. **Azure Backend**
   - Implement AzureStorage with azure-storage-blob
   - Support multiple auth methods
   - Document connection string setup

### Medium-term (v0.3.0+)

6. **Advanced Features**
   - Multipart uploads for large files
   - Progress callbacks
   - Retry logic with exponential backoff
   - Connection pooling configuration

7. **Performance & Production Readiness**
   - Benchmarks against django-storages
   - Security audit
   - Production deployment guide

---

## Open Questions

1. ~~**Exception naming** - Should we shadow builtins or prefix?~~ **Resolved: Prefix with `Storage`**

2. **Streaming uploads from Litestar's UploadFile** - Need to verify async iteration works correctly with all backends

3. **Connection pooling** - Should backends manage their own pools or accept external clients?

4. **Retry logic** - Built-in retries with backoff, or leave to user?

5. **Multipart uploads** - Automatic multipart for large files, or explicit API?

---

## References

- [Litestar Stores Documentation](https://docs.litestar.dev/2/usage/stores.html)
- [django-storages Documentation](https://django-storages.readthedocs.io/)
- [fastapi-storages Repository](https://github.com/aminalaee/fastapi-storages)
- [aioboto3 Documentation](https://aioboto3.readthedocs.io/)
- [gcloud-aio-storage](https://github.com/talkiq/gcloud-aio)
- [Azure Storage Blob (async)](https://learn.microsoft.com/en-us/python/api/azure-storage-blob/)

---

*Plan Version: 2.0.0*
*Last Updated: 2024-11*
*Status: Phase 1-3 Complete, Phase 4 In Progress*
